const spotifyRandom=(()=>{const e=["playlist-read-private","playlist-read-collaborative","user-modify-playback-state","user-library-read","user-read-playback-state"],t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s=new SpotifyWebApi;let o,n;function a(){if(o&&n&&(new Date).getTime()<n)return o;const s=function(){const e={},t=/([^&;=]+)=?([^&;]*)/g,s=window.location.hash.substring(1);let o;for(;o=t.exec(s);)e[o[1]]=decodeURIComponent(o[2]);return e}();if(s.state&&s.access_token&&s.expires_in&&s.state===localStorage.getItem("state"))return localStorage.removeItem("state"),o=s.access_token,n=(new Date).getTime()+s.expires_in,window.location.hash="",o;!function(){const s=Array.apply(null,Array(16)).map(()=>t.charAt(Math.floor(Math.random()*t.length))).join("");localStorage.setItem("state",s),window.location.href="https://accounts.spotify.com/authorize?client_id="+encodeURIComponent("b61d28d1ed4c49e8ba5d2923ed367262")+"&response_type="+encodeURIComponent("token")+"&redirect_uri="+encodeURIComponent("https://tomeraberba.ch/spotify-true-random")+"&state="+encodeURIComponent(s)+"&scope="+encodeURIComponent(e.join(" "))}()}return{token:a,playlists:e=>{s.setAccessToken(a()),s.getUserPlaylists({limit:50},(t,s)=>e(s))},tracks:(e,t)=>{const o=e.split(":")[1],n=e.split(":")[2];let i=0;const c=[];!function e(){s.setAccessToken(a()),s.getPlaylistTracks(o,{offset:i,limit:100,fields:"items(track(uri))"},(s,o)=>{o.items.map(e=>e.track.uri).forEach(e=>c.push(e)),i+=100,i<n?e():t(c)})}()},savedTracks:e=>{s.setAccessToken(a()),s.getMySavedTracks({limit:50},(t,o)=>{const n=o.total;let i=50;const c=o.items.map(e=>e.track.uri);!function t(){s.setAccessToken(a()),s.getMySavedTracks({offset:i,limit:50},(s,o)=>{o.items.map(e=>e.track.uri).forEach(e=>c.push(e)),i+=50,i<n?t():e(c)})}()})},library:(e,t)=>{let o=e.textContent;e.disabled=!0,s.setAccessToken(a()),s.getMySavedAlbums({limit:50},(n,i)=>{const c=i.total;let l=50;const r=i.items.map(e=>e.album.id);!function n(){s.getMySavedAlbums({offset:l,limit:50},(i,m)=>{if(m.items.map(e=>e.album.id).forEach(e=>r.push(e)),l+=50,e.textContent="Retrieving albums "+Math.min(l,c)+"/"+c,l<c)n();else{tracks=[];let n=0;!function i(){if(n<r.length){e.textContent="Retrieving tracks "+Math.min(n,r.length)+"/"+r.length;let t=0;s.getAlbumTracks(r[n],{offset:t,limit:50},(e,o)=>{const c=o.total;if(o.items.map(e=>e.uri).forEach(e=>tracks.push(e)),t+=50,t>=c)return n++,void i();!function e(){s.setAccessToken(a()),s.getAlbumTracks(r[n],{offset:t,limit:50},(s,o)=>{o.items.map(e=>e.uri).forEach(e=>tracks.push(e)),t+=50,t<c?e():(n++,i())})}()})}else e.disabled=!1,e.textContent=o,t(tracks)}()}})}()})},devices:e=>{s.setAccessToken(a()),s.getMyDevices((t,s)=>e(s.devices.filter(e=>!e.is_restricted)))},play:e=>{const t=document.getElementById("devices-select").value;""!==t&&(!function(e){for(let t=e.length-1;t>0;t--){let s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}}(e),s.setAccessToken(a()),s.play({uris:e.slice(0,Math.min(385,e.length)),device_id:t}))},refresh:()=>{spotifyRandom.token()&&(spotifyRandom.playlists(e=>{const t=document.getElementById("playlists-select");for(let e=t.length-1;e>=0;e--)t.remove(e);e.items.forEach(e=>{const s=document.createElement("option");s.text=e.name,s.value=e.owner.id+":"+e.id+":"+e.tracks.total,t.add(s)})}),spotifyRandom.devices(e=>{const t=document.getElementById("devices-select");for(let e=t.length-1;e>=0;e--)t.remove(e);if(0===e.length){const e=document.createElement("option");e.text="Please Open Spotify",e.value="",t.add(e)}else e.forEach(e=>{const s=document.createElement("option");s.text=e.name,s.value=e.id,t.add(s)})}))}}})();document.addEventListener("DOMContentLoaded",()=>spotifyRandom.refresh());